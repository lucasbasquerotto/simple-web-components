/*! Built with http://stenciljs.com */
const{h:t}=window.SimpleWebComponents;class e{constructor(){this.items=[],this.buffer=0,this.scrollAnimationTime=1500,this.cumulativeHeights=[],this.showAmountLoop=new Set,this.totalScrollHeight=-1,this.lastTopPadding=-1,console.log("virtual-scroll")}componentWillLoad(){console.log("componentWillLoad"),this.addParentEventHandlers(this.parentScroll||this.el)}componentDidLoad(){console.log("componentDidLoad"),this.refresh()}componentDidUnload(){this.removeParentEventHandlers()}componentWillUpdate(){console.log("componentWillUpdate"),this.refresh()}refresh(t=!1){window.requestAnimationFrame(()=>this.calculateItems(t))}addParentEventHandlers(t){if(this.removeParentEventHandlers(),console.log("parentScroll"),t){const e=()=>this.refresh();t.addEventListener("scroll",e),this.disposeScrollHandler=(()=>t.removeEventListener("scroll",e))}}removeParentEventHandlers(){this.disposeScrollHandler&&(this.disposeScrollHandler(),this.disposeScrollHandler=void 0)}getContent(){return this.el.shadowRoot.querySelector(".scrollable-content")}getShimElement(){return this.el.shadowRoot.querySelector(".total-padding")}calculateItems(t=!1){let{start:e=0,startBuffer:s=0,end:l=0,endBuffer:i=0}=this.calculateValues();if(e!==this.previousStart||l!==this.previousEnd||!0===t){let t=this.items||[];this.viewPortItems=t.slice(s,i),this.update&&this.update(this.viewPortItems),console.log("slice",e,l,s,i),e!==this.previousStart&&0===e&&this.start&&this.start({start:e,end:l}),l!==this.previousEnd&&l===t.length-1&&this.end&&this.end({start:e,end:l}),this.previousStart=e,this.previousStartBuffer=s,this.previousEnd=l;const o=l-e;if(!this.showAmountLoop.has(o))return this.showAmountLoop.add(o),this.refresh()}this.showAmountLoop.clear()}calculateValues(){let t=this.parentScroll||this.el,e=t.scrollTop,s=this.el.children,l=(this.items||[]).length,i=this.parentScroll?this.el.offsetTop:0,o=Math.max(0,(this.totalScrollHeight||0)-i),r=Math.max(0,e-i),a=t.clientHeight||0,n=0,h=0,c=0;if(s&&s.length){let t=this.previousStartBuffer||0,e=t,i=this.cumulativeHeights||[],o=i.length,m=0;if(o<e){o>0&&(m=i[o-1]);for(let t=o;t<e;t++)m+=c,i[t]=m;o=i.length}e&&(m=i[e-1]),console.log("current0",e,t);for(let t of Array.from(s))m+=t.getBoundingClientRect().height||c,i[e]=m,e++;for(c=Math.max(m/e,1),console.log("current1",e);r+a>m&&e<l;)m+=c,i[e]=m,e++;console.log("cumulativeHeight",m,i.length,e),this.cumulativeHeights=i.slice(0,e),o=i.length;let u=0,d=0,p=0;for(;u<o&&(d=p,!((p=i[u])>=r));)u++;for(n=u+(r-d)/(p-d);u<o&&(d=p,!((p=i[u])>=r+a));)u++;let g=u+(r+a-d)/(p-d);h=Math.ceil(g-n)}h=Math.max(h,0);let m=Math.max(0,this.buffer||0);l&&!h&&(h=Math.max(m,2));let u=Math.min(Math.ceil(n)+h,l),d=Math.min(u,Math.floor(n));d=Math.max(0,d||0),d=Math.min(d,l);let p=Math.min(d+h,l),g=d-m-1;g=Math.max(0,g);let f=p+m+1;f=Math.min(f,l);let v=this.cumulativeHeights[g-1]||0;if(v!==this.lastTopPadding){let t=this.getContent();t.style.transform=`translateY(${v}px)`,t.style.webkitTransform=`translateY(${v}px)`,this.lastTopPadding=v}o=c*l;const S=Math.max(0,o+i);return S!==this.totalScrollHeight&&(this.getShimElement().style.height=`${o}px`,this.totalScrollHeight=o,console.log("totalScrollHeight",S,o,l)),console.log("calc",d,g,p,f,h,r,o),{start:d,startBuffer:g,end:p,endBuffer:f,showCount:h}}render(){return[t("div",{class:"total-padding"}),t("div",{class:"scrollable-content"},t("slot",null))]}static get is(){return"sp-virtual-scroll"}static get encapsulation(){return"shadow"}static get properties(){return{buffer:{type:Number,attr:"buffer"},change:{type:"Any",attr:"change"},el:{elementRef:!0},end:{type:"Any",attr:"end"},items:{type:"Any",attr:"items"},parentScroll:{type:"Any",attr:"parent-scroll"},scrollAnimationTime:{type:Number,attr:"scroll-animation-time"},start:{type:"Any",attr:"start"},update:{type:"Any",attr:"update"}}}static get style(){return":host{overflow:hidden;overflow-y:hidden;position:relative;display:block;-webkit-overflow-scrolling:touch}.scrollable-content{top:0;left:0;width:100%;height:100%;position:absolute}.total-padding{width:1px;opacity:0}"}}class s{constructor(){this.count=0,this.amount=4e4,this.intervals=[3e3,6e3],this.items=this.createItems()}updateItems(t){console.log("updateItems",t,(this.items||[]).length),this.scrollItems=t}createItems(){let t=this.count*this.amount+1;this.count++;let e=(this.items||[]).concat(".".repeat(this.amount).split("").map((e,s)=>({name:"item-"+(s+t),text:"Item "+(s+t)})));return console.log("createItems",e.length),e}componentDidLoad(){for(let t of this.intervals||[])setTimeout(()=>this.items=this.createItems(),t)}render(){return t("div",null,"Hello, World! I'm ",this.first," ",this.last,t("br",null),t("sp-virtual-scroll",{items:this.items,update:t=>this.updateItems(t),change:t=>console.log("onVirtualChange",t),start:t=>console.log("onStart",t),end:t=>console.log("onEnd",t),parentScroll:this.el,buffer:10},(this.scrollItems||[]).map(e=>t("div",{class:e.name,style:{width:"100%"}},t("div",{style:{width:"100%"}},e.text),e.text.split("").map(e=>t("div",{style:{width:"100%"}},"|",e,"|"))))),"Hello, World! I'm ",this.first," ",this.last,t("br",null))}static get is(){return"virtual-scroll-example"}static get encapsulation(){return"shadow"}static get properties(){return{el:{elementRef:!0},first:{type:String,attr:"first"},items:{state:!0},last:{type:String,attr:"last"},scrollItems:{state:!0}}}static get style(){return":host{display:block;position:relative;height:100%;overflow-y:auto}"}}export{e as SpVirtualScroll,s as VirtualScrollExample};